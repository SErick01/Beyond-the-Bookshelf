<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Reads</title>
    <script src = "https://cdn.tailwindcss.com"></script>
    <script src ="hp.js"> </script>
    <script src="https://kit.fontawesome.com/42bbd9a803.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors : {
                        'primary-orange' : '#EB7F50',
                        'background-light': '#F2DBC8',
                        'card-background': '#E5C09E',
                        'dark-brown': '#51200F'
                    },
                    fontFamily: {
                        sans: ['sans-serif']
                    }
                }
            }
        }
    </script>
<!--test-->
    <style>
        section, .calendar-box, .cat-of-the-day-card {
            padding: 1.25rem; /* p-5 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .nav-link {
        color: #000;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.2s ease;
        }  
    
        .nav-link:hover {
        color: #51200F;
        }
        .calendar-box {
            background-color: var(--tw-colors-sidebar-bg);
            color: var(--tw-colors-dark-brown);
        }

        .calendar .Weeks {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            list-style: none;
            padding: 0;
            text-align: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid rgba(81, 32, 15, 0.2);
            padding-bottom: 5px;
        }

        .calendar .Days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            list-style: none;
            padding: 0;
            text-align: center;
        }

        .calendar .Days li {
            padding: 0.5rem 0;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            border-radius: 9999px; /* full rounded */
        }

        .calendar .Days li.inactive {
            color: rgba(81, 32, 15, 0.5); /* lighter dark-brown */
            cursor: default;
        }

        .calendar .Days li.active {
            background-color: var(--tw-colors-primary-orange);
            color: #EB7F50;
            font-weight: bold;
        }

        .calendar .icons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .calendar .icons span {
            cursor: pointer;
            color: var(--tw-colors-dark-brown);
            padding: 0.25rem;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }

        .calendar .icons span:hover {
            background-color: rgba(81, 32, 15, 0.1);
        }

    </style>
</head>

<body class ="bg-background-light shadow-lg sticky top-0 z-20">
    <header class="bg-primary-orange shadow-lg sticky top-0 z-20">
        <div class="flex  justify-between items-center p-4">
            <div class="flex items-center space-x-3">
                <div class="w-16 h-16">
                    <div class="w-16 h-16">
                    <img 
                        src="Cat_Logo.png" 
                        alt="Cat Logo" 
                        class="w-full h-full object-contain" 
                    >
                    </div>
                </div>
                <h1 class="text-2xl font-extrabold text-black">
                    <a href ="better_reads_hp.html"> BETTER READS</a>
                </h1>
            </div>
            
            <div class="flex items-center">
                <nav class="hidden md:flex space-x-6">
                    <a id="nav-login" href="index.html" class="nav-link">LOGIN</a>
                    <a id="nav-logout" href="#" class="nav-link" style="display:none">LOGOUT</a>
                    <a href="better_reads_PROFILE.html" class="nav-link">PROFILE</a>
                    <a href="better_reads_mb.html" class="nav-link">MY BOOKS</a>
                    <a href="better_reads_browse.html" class="nav-link">BROWSE</a>
                    <div class = "relative " id = "dropdown-parent">
                        <button 
                            class="Drop-Down-Menu-Icon-BTN"
                            aria-expanded="false"
                            aria-haspopup="true"
                            onclick="toggleDropdown(event)"
                            >
                            &#9776;
                        </button>
                        <div
                         id = "dropdown-menu"
                         class = "absolute right-0 mt-3 w-40 bg-white border border-gray-200 rounded-lg shadow-xl hidden origin-top-right transform transition duration-200 ease-out z-30 overflow-hidden">
                        <a href="add-friends.html" class="block px-4 py-2 text-gray-700 hover:bg-orange-100 hover:text-primary-orange transition duration-150 whitespace-nowrap">
                            Add Friends
                        </a>
                        <a href="#" class="block px-4 py-2 text-red-600 hover:bg-red-50 transition duration-150 whitespace-nowrap">
                            Logout
                        </a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>
 
<!-- Banner and Website Logo -->
<main class="relative mb-8 shadow-xl">
    <img 
        src="ross-tejada-studying-cat-banner.jpg" 
        alt="Pixel Art Cat Reading" 
        class="w-full max-h-80 h-full object-cover"
    >
    
</main>
<!-- Creation of the current reads -->
<div class = "container mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6 pb-12">
    <section class = "lg:col-span-3 space-y-6 bg-[#BAAF6F] rounded-lg">
        <h2 class = text-2xl font-bold text-dark-text mb-4 >Current Reads</h2>

        <!--Book 1-->
        <div class ="Current-Read-item-1 flex space-x-4 items-start bg-sidebar-bg/70 p-3 rounded-lg">
            <img id="current-cover-1" src = "76713323._SY180_.jpg" alt = "Cover" class = "w-16 h-24 object-cover shadow-md rounded">
            <div class = "flex-grow">
                <p id="current-title-1" class = "font-bold text-base leading-tight">Empire of Storms</p>
                <p id="current-author-1" class = "text-sm text-dark-text/80">Sarah J. Maas </p>
                <div class = "w-full h-2 bg-dark-brown/30 rounded-full mt-2 overflow-hidden relative">
                    <div id="progress-bar-1" 
                        class="bg-primary-orange h-full rounded-full transition-all duration-500 ease-out flex items-center justify-center" 
                        style="width: 25%">
                        <span id="progress-text-1" class="text-white font-bold text-xs" 
                            style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);">
                        </span>
                    </div>
                </div>
                <button id = "update-progress-btn-1" onclick="openModal(1)"
                    class="mt-3 bg-[EB7F50] text-white text-sm px-4 py-1 rounded-full shadow hover:bg-dark-brown transition duration-200"> 
                    Update Progress
                </button>
            </div>
        </div> 
        <!--Book 2-->
        <div class ="Current-Read-item-2 flex space-x-4 items-start bg-sidebar-bg/70 p-3 rounded-lg">
            <img id="current-cover-2" src = "222946916._SY180_.jpg" alt = "Cover" class = "w-16 h-24 object-cover shadow-md rounded">
            <div class = "flex-grow">
                <p id="current-title-2" class = "font-bold text-base leading-tight">For Whom the Belle Tolls</p>
                <p id="current-author-2" class = "text-sm text-dark-text/80">Jaysea Lynn</p>
                <div class = "w-full h-2 bg-dark-brown/30 rounded-full mt-2 overflow-hidden relative">
                    <div id="progress-bar-2" 
                        class="bg-primary-orange h-full rounded-full transition-all duration-500 ease-out flex items-center justify-center" 
                        style="width: 25%">
                        <span id="progress-text-2" class="text-white font-bold text-xs" 
                            style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);">
                        </span>
                    </div>
                </div>
                <button id = "update-progress-btn-2" onclick="openModal(2)"
                    class="mt-3 bg-[EB7F50] text-white text-sm px-4 py-1 rounded-full shadow hover:bg-dark-brown transition duration-200"> 
                    Update Progress
                </button>
            </div>
        </div> 
    </section>


<!-- Recommendation Panel -->
    <div class ="lg:col-span-6 space-y-6" >
        <section class = "bg-card-background">
            <h2 id="recommended-heading" class = "text-2xl font-bold text-dark-text mb-6">Recommended for you</h2>
            <div id="row-recommended" class = "Recommended-books grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-3 bg-E5C09E"></div>
        </section>

        <section class = "bg-card-background rounded-lg">
            <h2 class="text-xl font-bold mb-4"> Friend Activity</h2>
            <div class="friend-updates space-y-4">

                <div class="update-item flex justify-between items-center p-3 bg-card-background/70 border border-dark-brown rounded-lg">
                    <!--Profile Pics-->
                    <img 
                        src="https://placehold.co/50x50/EB7F50/FFFFFF?text=M"
                        alt="Mandie's Profile Picture"
                        class="w-10 h-10 object-cover rounded-full shadow-md mr-4"
                        onerror="this.src='https://placehold.co/50x50/EB7F50/FFFFFF?text=M'"
                    >  

                    <div class="flex-grow flex flex-col justify-center p-2">
                        <p class = "text-sm">
                            <strong class="font-semibold">Mandie</strong> rated a book 
                            <span class="text-star-grey text-lg leading-none align-middle inline-block">
                                ★★★★★
                            </span>
                        </p>
                        <p class="text-xs italic mt-0.5">
                            "Tower of Dawn" by Sarah J. Maas
                        </p>
                        <p class = "text-text-sm mt-2 p-2 border-l-2 border-primary-orange bg-[#FFF8F3] rounded-r shadow-inner text-dark-brown">
                           "Omg it had me crying"
                            <!--Comments-->
                        </p>
                        
                        
                    </div>
                    <img 
                        src = "tod.jpg"
                        alt = "Tower of Dawn"
                        class = "w-12 h-20 object-cover rounded shadow"
                    >
                </div>
                 <div class="update-item flex justify-between items-center p-3 bg-card-background/70 border border-dark-brown rounded-lg">
                    <!--Profile Pics-->
                    <img 
                        src="https://placehold.co/50x50/EB7F50/FFFFFF?text=M"
                        alt="Matt's Profile Picture"
                        class="w-10 h-10 object-cover rounded-full shadow-md mr-4"
                        onerror="this.src='https://placehold.co/50x50/EB7F50/FFFFFF?text=M'"
                    >  

                    <div class="flex-grow flex flex-col justify-center p-2">
                        <p class = "text-sm">
                            <strong class="font-semibold">Matt</strong> rated a book 
                            <span class="text-star-grey text-lg leading-none align-middle inline-block">
                                ★★★★
                            </span>
                            <span class="text-dark-brown/30 text-lg leading-none align-middle inline-block">
                                ★
                            </span>
                        </p>
                        <p class="text-xs italic mt-0.5">
                            "Red Rising" by Pierce Brown
                        </p>
                        <p class = "text-text-sm mt-2 p-2 border-l-2 border-primary-orange bg-[#FFF8F3] rounded-r shadow-inner text-dark-brown">
                            "A dystopian masterpiece. Darrow's journey is a must-read for any sci-fi fan."
                            <!--Comments-->
                        </p>
                        
                    </div>
                    <img 
                        src = "redrising.jpg"
                        alt = "Red Rising"
                        class = "w-12 h-20 object-cover rounded shadow"
                    >
                 </div>
            </div>
        </section>
    </div>

    <aside class="lg:col-span-3 space-y-6">
        <div class="calendar-box bg-sidebar-bg">
            <div class="icons flex justify-between items-center mb-2">
                <span class="material-symbols-rounded cursor-pointer" onclick="navigateCalendar(-1)">chevron_left</span>
                <p id="current-date" class="font-bold text-xl">November 2025</p>
                <span class="material-symbols-rounded cursor-pointer" onclick="navigateCalendar(1)">chevron_right</span>
             </div>
            <div class = "calendar">
                <ul class ="Weeks"> 
                    <li>Sun</li>
                    <li>Mon</li>
                    <li>Tue</li>
                    <li>Wed</li>
                    <li>Thu</li>
                    <li>Fri</li>
                    <li>Sat</li>
                </ul>
                <ul class ="Days"> </ul>
            </div>
                
        </div>
        <section class="bg-[#BAAF6F]">
            <h2 id ="challenge-year" 
                class="text-xl font-bold mb-4">Reading Challenge (2025)
            </h2>
            <div class="Challenge-box flex items-center">
                <div class="mr-4">
                    <svg class="w-12 h-12 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.206 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.794 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.794 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.206 18 16.5 18s-3.332.477-4.5 1.253" />
                    </svg>
                </div>
                <div>
                    <p id ="books-completed" class="text-4xl font-extrabold text-primary">--</p>
                    <p class="text-dark-text/80">books completed of <span id ="target-count">--</span></p>
                </div>
                <button 
                    id="set-goal-btn"
                    onclick="openGoalModal()"
                    class="bg-dark-brown text-white text-sm px-4 py-2 rounded-full shadow hover:bg-dark-brown/80 transition duration-200 whitespace-nowrap"
                >
                    Set Goal
                </button>
            </div>
        </section>  
    
        <div class="cat-of-the-day-card bg-[#BAAF6F]">
                <h3 class="font-bold text-xl mb-3">Cat of the Day</h3>
                <img 
                    src="karly-jones-tsdop0ikzs8-unsplash.jpg" 
                    alt="Black Cat in a Basket" 
                    class="w-full h-auto object-cover rounded-lg shadow-lg"
                >
            </div>

        </aside>
</div>  

<div 
    id="progress-modal" 
    class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center transition-opacity duration-300"
    onclick="closeModalOnOutsideClick(event)"
>
    <div 
        class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm m-4 transform scale-100 transition-transform duration-300" 
        onclick="event.stopPropagation()"
    >
        <h3 class="text-xl font-bold mb-4">Update Reading Progress</h3>
        <p class="text-sm text-gray-600 mb-2">Enter the page you’re currently on.</p>
        <p id="total-pages-label" class="text-xs text-gray-500 mb-4"></p>

        <label for="page-input" class="block text-sm font-medium text-gray-700 mb-2">Current page number</label>
        <input 
            type="number" id="page-input" name="page-input" min="0" step="1"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-orange focus:border-primary-orange text-lg mb-4"
        />

        <div id="error-message" class="text-red-500 text-sm mb-4 hidden"></div>

        <div class="flex justify-end space-x-3">
            <button 
                onclick="closeModal()" 
                class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150"
            >
                Cancel
            </button>
            <button 
                onclick="updateProgress()" 
                class="px-4 py-2 text-white bg-primary-orange rounded-lg hover:bg-dark-brown font-semibold transition duration-150"
            >
                Submit Update
            </button>
        </div>
    </div>
</div>

<div id="rating-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h3 class="text-2xl font-bold mb-2">Congratulations!</h3>
        <p class="mb-4">You've finished the book. How would you rate it?</p>
        
        <div id="star-rating-container" class="text-3xl text-yellow-500 mb-6">
            <span class="cursor-pointer hover:opacity-75" data-rating="1">★</span>
            <span class="cursor-pointer hover:opacity-75" data-rating="2">★</span>
            <span class="cursor-pointer hover:opacity-75" data-rating="3">★</span>
            <span class="cursor-pointer hover:opacity-75" data-rating="4">★</span>
            <span class="cursor-pointer hover:opacity-75" data-rating="5">★</span>
        </div>
        
        <p id="selected-rating" class="mb-4 text-gray-600">Click a star to rate</p>
        
        <div class="flex justify-center space-x-3">
            <button onclick="closeRatingModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Skip</button>
            <button onclick="saveRating()" class="bg-[EB7F50] text-white px-4 py-2 rounded hover:bg-dark-brown">Submit Rating</button>
        </div>
    </div>
</div>
</body>

<footer class="bg-dark-brown text-white py-4 mt-auto">
    <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center px-4">
        <div class="footer-links space-x-4 mb-2 sm:mb-0">
            <a href="#" class="hover:text-primary transition">About the Company</a>
            <a href="#" class="hover:text-primary transition">Contact Us</a>
        </div>
        <p class="copyright">&copy; Copyright 2025 | Better Reads</p>
    </div>
</footer>
<script>
    let date = new Date();
    let currYear = date.getFullYear();
    let currMonth = date.getMonth(); 
    const monthNames = ["January", "February", "March", "April", "May", "June", "July",
                    "August", "September", "October", "November", "December"];

    // --- DOM Elements (Accessed via DOMContentLoaded) ---
    const currentDateEl = document.getElementById("current-date");
    const daysContainer = document.querySelector(".Days");

    function renderCalendar() {
    let lastDayOfMonth = new Date(currYear, currMonth + 1, 0).getDate();
    let firstDayOfMonthIndex = new Date(currYear, currMonth, 1).getDay();
    let lastDayOfLastMonth = new Date(currYear, currMonth, 0).getDate();
    let liTag = "";

    for (let i = firstDayOfMonthIndex; i > 0; i--) {
        liTag += `<li class="inactive">${lastDayOfLastMonth - i + 1}</li>`;
    }

    for (let i = 1; i <= lastDayOfMonth; i++) { 
        let isToday = i === new Date().getDate() && currMonth === new Date().getMonth() 
            && currYear === new Date().getFullYear() ? "active" : "";
        liTag += `<li class="${isToday}">${i}</li>`;
    }

    const totalCells = firstDayOfMonthIndex + lastDayOfMonth;
    const remainingCells = 42 - totalCells; 
    const nextMonthStart = totalCells <= 35 ? (35 - totalCells) : (42 - totalCells);
    for (let i = 1; i <= nextMonthStart; i++) {
        liTag += `<li class="inactive">${i}</li>`;
    }

    currentDateEl.textContent = `${monthNames[currMonth]} ${currYear}`;
    daysContainer.innerHTML = liTag;
    }

    function navigateCalendar(nav) {
    currMonth += nav;
    if (currMonth < 0 || currMonth > 11) {
        date = new Date(currYear, currMonth);
        currYear = date.getFullYear();
        currMonth = date.getMonth();
    } 
    renderCalendar();
    }

    window.navigateCalendar = navigateCalendar;
    renderCalendar();
</script>
<script>
    const apiBase = 'https://beyond-the-bookshelf.onrender.com';
    const token = localStorage.getItem('btb_token');
    
    if (token) {
        fetch(`${apiBase}/api/users/me`, {
            headers: { Authorization: `Bearer ${token}` },
            mode: 'cors'
        })

        .then(async (res) => {
            if (!res.ok) {
                const body = await res.text();
                throw new Error(`API ${res.status}: ${body}`);
            }
            return res.json();
        })

        .then((me) => {
            console.log('Welcome:', me.email);
        })

        .catch((err) => {
            console.error(err);
            window.location.href = 'index.html';
        });
    }
</script>
<script>
    (function () {
        const loginLink = document.getElementById('nav-login');
        const logoutLink = document.getElementById('nav-logout');

        if (!loginLink || !logoutLink) return;
        const token = localStorage.getItem('btb_token');

        if (token) {
            loginLink.style.display = 'none';
            logoutLink.style.display = '';
        } else {
            loginLink.style.display = '';
            logoutLink.style.display = 'none';
        }

        logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();

            try {
                if (window.supabase?.auth?.signOut) {
                    await window.supabase.auth.signOut();
                } else {
                    Object.keys(localStorage).filter(k => k.includes('supabase')
                    && k.includes('auth')).forEach(k => localStorage.removeItem(k));
                }
            } catch (_) {}

            localStorage.removeItem('btb_token');
            window.location.href = 'index.html';
        });
    })();
</script>
<script>
  const CURRENT_CHALLENGE_YEAR = new Date().getFullYear();

  async function fetchReadingChallenge() {
    const token = localStorage.getItem('btb_token');
    const booksCompletedEl = document.getElementById('books-completed');
    const targetCountEl = document.getElementById('target-count');
    const challengeYearEl = document.getElementById('challenge-year');

    if (challengeYearEl) {challengeYearEl.textContent = `Reading Challenge (${CURRENT_CHALLENGE_YEAR})`;}

    if (!token) {
      console.log('[ReadingChallenge] No token found');
      if (booksCompletedEl) booksCompletedEl.textContent = '0';
      if (targetCountEl) targetCountEl.textContent = '--';
      return;
    }

    try {
      const res = await fetch(
        `${apiBase}/api/reading-challenge/current?year=${CURRENT_CHALLENGE_YEAR}`,
        {headers: { Authorization: `Bearer ${token}` }, mode: 'cors',}
      );

      if (!res.ok) {
        console.warn('[ReadingChallenge] API error', res.status);
        if (booksCompletedEl) booksCompletedEl.textContent = '0';
        if (targetCountEl) targetCountEl.textContent = '--';
        return;
      }
      const data = await res.json();
      const completed = data.completed_count ?? 0;
      const target = data.target_count ?? '--';

      if (booksCompletedEl) booksCompletedEl.textContent = completed;
      if (targetCountEl) targetCountEl.textContent = target;

    } catch (err) {
      console.error('[ReadingChallenge] Fetch failed', err);
      if (booksCompletedEl) booksCompletedEl.textContent = '0';
      if (targetCountEl) targetCountEl.textContent = '--';
    }
  }
  fetchReadingChallenge();
</script>
<script>
    (async () => {
        const STORAGE_BASE = "https://swfkspdirzdqotywgvop.supabase.co/storage/v1/object/public/";
        const PLACEHOLDER = STORAGE_BASE + "cover/placeholder.jpg";

        function setCurrentSlot(slot, data) {
            if (!data) return;

            const coverEl  = document.getElementById(`current-cover-${slot}`);
            const titleEl  = document.getElementById(`current-title-${slot}`);
            const authorEl = document.getElementById(`current-author-${slot}`);
            const barEl    = document.getElementById(`progress-bar-${slot}`);
            const textEl   = document.getElementById(`progress-text-${slot}`);

            if (coverEl) {
                let imgSrc = PLACEHOLDER;
                if (data.cover_url) {
                    imgSrc = data.cover_url.startsWith("http")
                        ? data.cover_url
                        : STORAGE_BASE + data.cover_url.replace(/^\/+/, "");
                }
                coverEl.src = imgSrc;
                coverEl.alt = data.title ?? "Current read";
            }

            if (titleEl)  titleEl.textContent  = data.title  ?? "Untitled";
            if (authorEl) authorEl.textContent = data.author ?? "Unknown author";

            if (barEl) {
                const pct = Math.max(0, Math.min(100, data.progress_percent ?? 0));
                barEl.style.width = pct + "%";
                if (textEl) textEl.textContent = pct.toFixed(1).replace(/\.0$/, "") + "%";
            }
        }

        const token = localStorage.getItem("btb_token");
        if (!token) {
            console.log("[CurrentReads] No token, leaving sample books");
            return;
        }

        try {
            const res = await fetch(
                `${apiBase}/api/home/current-reads?limit=2`,
                {headers: { Authorization: `Bearer ${token}` }, mode: "cors",}
            );

            if (!res.ok) {
                console.warn("[CurrentReads] API error", res.status);
                return;
            }

            const rows = await res.json();
            window.currentReads = {};
            if (rows[0]) {
                window.currentReads[1] = rows[0];
                setCurrentSlot(1, rows[0]);
            }

            if (rows[1]) {
                window.currentReads[2] = rows[1];
                setCurrentSlot(2, rows[1]);
            }

        } catch (err) {console.error("[CurrentReads] Fetch failed", err);}
    })();
</script>
<script>
  (async () => {
    const SUPABASE_URL = "https://swfkspdirzdqotywgvop.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3ZmtzcGRpcnpkcW90eXdndm9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDk4OTEsImV4cCI6MjA3NDgyNTg5MX0.KEH4KkXwYBFA3Frw_Yx8vXPmB2bzJwmdcFhb2Fg6dWY";
    const STORAGE_BASE = `${SUPABASE_URL}/storage/v1/object/public/`;
    const PLACEHOLDER = STORAGE_BASE + "cover/placeholder.jpg";
    const recHeading   = document.getElementById("recommended-heading");
    const rowContainer = document.getElementById("row-recommended");

    if (!rowContainer) {
      console.warn("[Recommended] Missing #row-recommended container");
      return;
    }

    rowContainer.innerHTML =
      `<p class="col-span-3 text-center text-sm text-[#51200F]">
         Loading recommendations…
       </p>`;

    function renderRow(rows) {
      if (!rows || !rows.length) {
        rowContainer.innerHTML =
          `<p class="col-span-3 text-center text-sm text-[#51200F]">
             No recommendations yet.
           </p>`;
        return;
      }

      const frag = document.createDocumentFragment();
      for (const row of rows) {
        const title = row?.works?.title ?? "Unknown title";
        let imgSrc = PLACEHOLDER;

        if (row.cover_url) {
          imgSrc = row.cover_url.startsWith("http")
            ? row.cover_url
            : STORAGE_BASE + row.cover_url.replace(/^\/+/, "");
        }
        const a = document.createElement("a");
        a.href =
          `View-book.html?work_id=${encodeURIComponent(row.work_id)}` +
          `&edition_id=${encodeURIComponent(row.edition_id)}`;
        a.className = "block";

        const img = document.createElement("img");
        img.src = imgSrc;
        img.alt = title;
        img.className = "w-full h-auto object-cover shadow-xl rounded " +
        "hover:scale-[1.03] transition-transform duration-300 cursor-pointer";

        img.onerror = () => {
            img.onerror = null;
            img.src = PLACEHOLDER;

            if (!a.querySelector("p")) {
                const p = document.createElement("p");
                p.textContent = title;
                p.className = "mt-1 text-xs font-semibold text-center text-[#51200F]";
                a.appendChild(p);
            }
        };

        a.appendChild(img);
        if (!row.cover_url || /placeholder\.jpg$/i.test(imgSrc)) {
            const p = document.createElement("p");
            p.textContent = title;
            p.className = "mt-1 text-xs font-semibold text-center text-[#51200F]";
            a.appendChild(p);
        }

        const wrap = document.createElement("div");
        wrap.className = "book-card";
        wrap.appendChild(a);
        frag.appendChild(wrap);
      }
      rowContainer.innerHTML = "";
      rowContainer.appendChild(frag);
    }

    async function fetchBooks(limit = 21) {
      const url = new URL(`${SUPABASE_URL}/rest/v1/editions`);
      url.searchParams.set("select", "edition_id,work_id,cover_url,works!inner(title)");
      url.searchParams.set("order", "pub_date.desc");
      url.searchParams.set("limit", String(limit));

      const res = await fetch(url.toString(), {
        headers: {apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`,},
      });

      if (!res.ok) {
        console.error("[Recommended] Supabase error", res.status);
        rowContainer.innerHTML =
          `<p class="col-span-3 text-center text-sm text-red-700">
             Error loading recommendations (Supabase ${res.status}).
           </p>`;
        return [];
      }
      return await res.json();
    }

    try {
      const rows = await fetchBooks(21);
      renderRow(rows);
      if (recHeading) recHeading.textContent = "Recommended for you";

    } catch (err) {
      console.error("[Recommended] Fetch failed", err);
      rowContainer.innerHTML =
        `<p class="col-span-3 text-center text-sm text-red-700">
           Error loading recommendations. See console for details.
         </p>`;
    }
  })();
</script>
</body>
</html>