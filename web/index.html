<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title> Better Reads - Login</title>
    <style>
        .pixel-bg {
            background-image: url('https://i1.sndcdn.com/artworks-000649156789-lx91i9-t500x500.jpg');
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
        }
        .nav-link {
        color: #000;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.2s ease;
    }
    
    .nav-link:hover {
        color: #51200F;
    }
    </style>
</head>

<body class="pixel-bg min-h-screen flex flex-col">
        <header class="bg-[#EB7F50] shadow-lg sticky top-0 z-20">
        <div class="flex  justify-between items-center p-4">
            <div class="flex items-center space-x-3">
                <div class="w-16 h-16">
                    <div class="w-16 h-16">
                    <img 
                        src="Cat_Logo.png" 
                        alt="Cat Logo" 
                        class="w-full h-full object-contain" 
                    >
                    </div>
                </div>
                <h1 class="text-2xl font-extrabold text-black">
                   <a href ="better_reads_hp.html"> BETTER READS</a>
                </h1>
            </div>
            
            <div class="flex items-center">
                <nav class="hidden md:flex space-x-6">
                    <a href="index.html" class="nav-link">LOGIN</a>
                    <a href="better_reads_PROFILE.html" class="nav-link">PROFILE</a>
                    <a href="better_reads_mb.html" class="nav-link">MY BOOKS</a>
                    <a href="better_reads_browse.html" class="nav-link">BROWSE</a>
                    <button class="Drop-Down-Menu-Icon">&#9776;</button>
                </nav>
            </div>
        </div>
    </header>
    

    <main class="flex flex-grow justify-center items-center py-12">
        <div class="flex flex-col items-center w-full max-w-lg">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-8 drop-shadow-lg">Better Reads</h1>
            <div class="bg-[#EB7F50] p-8 sm:p-10 w-full max-w-sm rounded-xl shadow-2xl text-center bg-opacity-30">
                <form id="login-form" class="space-y-5"> 
                    <h2 class="text-3xl font-bold text-white mb-6">Login</h2>
                    <div class="input-box">
                        <input 
                            type="email"
                            id="email"
                            name="email"
                            placeholder="Email" 
                            required 
                            class="w-full p-3 rounded-full bg-white bg-opacity-70 border border-gray-300 placeholder-gray-700 focus:ring-2 focus:ring-[#EB7F50] focus:border-transparent outline-none text-gray-800"
                        >
                    </div>
                    <div class="input-box">
                        <input 
                            type="password"
                            id="password"
                            name="password"
                            placeholder="Password" 
                            required 
                            class="w-full p-3 rounded-full bg-white bg-opacity-70 border border-gray-300 placeholder-gray-700 focus:ring-2 focus:ring-[#EB7F50] focus:border-transparent outline-none text-gray-800"
                        >
                    </div>
                    <div class="flex justify-between items-center text-sm text-white pt-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox text-[#EB7F50] rounded-sm focus:ring-0 bg-white border-gray-300"> 
                            <span>Remember Me</span>
                        </label>
                        <a id="forgot-link" href="#" class="hover:underline text-white font-semibold">Forgot Password</a>
                    </div>
                    <button 
                        type="submit" 
                        class="w-full py-3 mt-4 bg-white text-[#EB7F50] font-bold rounded-full text-lg shadow-md hover:bg-gray-100 transition duration-200"
                    >
                        Login
                    </button>
                    <div class="register-link pt-4">
                        <p class="text-white text-sm">
                            Don't have an account? 
                            <a id="signup-link" href="#" class="font-bold hover:underline" role="button">Sign Up</a>
                        </p>
                        <p id="login-error" class="mt-2 text-sm text-red-200 hidden"></p>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer class="bg-[#51200F] text-white py-4 mt-auto">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center px-4">
            <div class="footer-links space-x-4 mb-2 sm:mb-0">
                <a href="#" class="hover:text-primary transition">About the Company</a>
                <a href="#" class="hover:text-primary transition">Contact Us</a>
            </div>
            <p class="copyright">&copy; Copyright 2025 | Better Reads</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://swfkspdirzdqotywgvop.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3ZmtzcGRpcnpkcW90eXdndm9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDk4OTEsImV4cCI6MjA3NDgyNTg5MX0.KEH4KkXwYBFA3Frw_Yx8vXPmB2bzJwmdcFhb2Fg6dWY";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const form = document.getElementById("login-form");
        const emailEl = document.getElementById("email");
        const passEl = document.getElementById("password");
        const errEl = document.getElementById("login-error");
        const signupLink = document.getElementById('signup-link');

        signupLink?.addEventListener('click', async (e) => {
            e.preventDefault();
            errEl.classList.add('hidden');

            if (errEl) errEl.textContent = '';
            const email = emailEl.value.trim();
            const password = passEl.value;

            if (!email || !password) {
                if (errEl) {
                    errEl.textContent = 'Enter email and password to sign up.';
                    errEl.classList.remove('hidden');
                }
                return;
            }
            try {
                const { data, error } = await supabase.auth.signUp({
                    email, password, options: {emailRedirectTo: window.location.origin + '/index.html' }
                });
                if (error) throw error;

                if (!data.session) {
                    if (errEl) {
                        errEl.textContent = 'Check your email to confirm your account, then return to log in.';
                        errEl.classList.remove('hidden');
                    }
                    return;
                }
                const token = data.session.access_token;
                localStorage.setItem('btb_token', token);
                window.location.href = 'better_reads_hp.html';
            } catch (err) {
                if (errEl) {
                    errEl.textContent = err?.message || 'Sign up failed.';
                    errEl.classList.remove('hidden');
                }
            }
        });

        (async () => {
        if (window.location.hash.includes('recovery')) {
            try {
            if (typeof supabase.auth.exchangeCodeForSession === 'function') {
                await supabase.auth.exchangeCodeForSession(window.location.href);
            }
            } catch (_) {}
            const newPass = window.prompt('Enter a new password (8+ characters):') || '';
            if (newPass.length < 8) {
            errEl && (errEl.textContent = 'Password must be at least 8 characters.');
            errEl?.classList.remove('hidden');
            return;
            }

            try {
            const { error } = await supabase.auth.updateUser({ password: newPass });
            if (error) throw error;
            window.location.hash = '';
            await supabase.auth.signOut();
            errEl && (errEl.textContent = 'Password updated. Please log in with your new password.');
            errEl?.classList.remove('hidden');
            } catch (e) {
            errEl && (errEl.textContent = e?.message || 'Could not update password.');
            errEl?.classList.remove('hidden');
            }
        }
        })();

        const forgotLink = document.getElementById('forgot-link');
        forgotLink?.addEventListener('click', async (e) => {
        e.preventDefault();
        errEl?.classList.add('hidden');
        const email = emailEl?.value.trim();

        if (!email) {
            if (errEl) {
            errEl.textContent = 'Enter your email above to reset your password.';
            errEl.classList.remove('hidden');
            }
            return;
        }
        try {
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.origin + '/index.html#recovery'
            });
            if (error) throw error;
            if (errEl) {
            errEl.textContent = 'Password reset email sent. Check your inbox.';
            errEl.classList.remove('hidden');
            }
        } catch (err) {
            if (errEl) {
            errEl.textContent = err?.message || 'Could not send reset email.';
            errEl.classList.remove('hidden');
            }
        }
        });

        (() => {
            const emailEl = document.getElementById('email');
            const errEl   = document.getElementById('error');
            const forgotLink =
                document.getElementById('forgot-password') ||
                Array.from(document.querySelectorAll('a'))
                .find(a => a.textContent.trim().toLowerCase() === 'forgot password');

            if (!forgotLink) return;

            forgotLink.addEventListener('click', async (e) => {
                e.preventDefault();
                errEl?.classList.add('hidden');
                errEl && (errEl.textContent = '');
                const email = emailEl?.value.trim();
                
                if (!email) {
                if (errEl) { errEl.textContent = 'Enter your email first to reset your password.'; errEl.classList.remove('hidden'); }
                return;
                }

                try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/index.html#password-reset'
                });
                if (error) throw error;
                if (errEl) {
                    errEl.textContent = 'Check your email for a reset link.';
                    errEl.classList.remove('hidden');
                }
                } catch (err) {
                if (errEl) { errEl.textContent = err.message || 'Could not send reset email.'; errEl.classList.remove('hidden'); }
                }
            });
            })();

        function showError(msg) {
            if (!errEl) return alert(msg);
            errEl.textContent = msg;
            errEl.classList.remove("hidden");
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            errEl?.classList.add("hidden");

            const btn = form.querySelector('button[type="submit"], button');
            if (btn) btn.disabled = true;

            try {
                const email = emailEl.value.trim();
                const password = passEl.value;
                const {data, error} = await supabase.auth.signInWithPassword({email, password});
                
                if (error) throw new Error(error.message);
                const token = data.session?.access_token;
                
                if (!token) throw new Error("No session token returned.");
                localStorage.setItem("btb_token", token);
                window.location.href = "better_reads_hp.html";
            
            } catch (err) {
                showError(err?.message || String(err));
            } finally {
                if (btn) btn.disabled = false;
            }            
        });

    supabase.auth.onAuthStateChange(async (event) => {
    if (event === 'PASSWORD_RECOVERY') {
        const newPass = window.prompt('Enter a new password (8+ characters):') || '';
        if (newPass.length < 8) {
        showError('Password must be at least 8 characters.');
        return;
        }
        const { error } = await supabase.auth.updateUser({ password: newPass });
        if (error) {
        showError(error.message || 'Could not update password.');
        return;
        }
        window.location.hash = '';
        await supabase.auth.signOut();
        showError('Password updated. Please log in with your new password.');
    }
    });

    </script>
</body>
</html>
