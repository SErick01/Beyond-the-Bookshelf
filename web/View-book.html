<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Reads - Red Rising</title>
    <script src = "https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/42bbd9a803.js" crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors : {
                        'primary-orange' : '#EB7F50',
                        'background-light': '#F2DBC8',
                        'card-background': '#E5C09E',
                        'dark-brown': '#51200F'
                    },
                    fontFamily: {
                        sans: ['sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        section, .calendar-box, .cat-of-the-day-card {
            padding: 1.25rem; /* p-5 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .nav-link {
        color: #000;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.2s ease;
    }
    
    .nav-link:hover {
        color: #51200F;
    }
    </style>
</head>
<body class ="bg-[#F2DBC8] shadow-lg sticky top-0 z-20">
    <header class="bg-[#EB7F50] shadow-lg sticky top-0 z-20">
        <div class="flex  justify-between items-center p-4">
            <div class="flex items-center space-x-3">
                <div class="w-16 h-16">
                    <div class="w-16 h-16">
                    <img 
                        src="Cat_Logo.png" 
                        alt="Cat Logo" 
                        class="w-full h-full object-contain" 
                    >
                    </div>
                </div>
                <h1 class="text-2xl font-extrabold text-black">
                    <a href ="better_reads_hp.html"> BETTER READS</a>
                </h1>
            </div>
            
            <div class="flex items-center">
                <nav class="hidden md:flex space-x-6">
                    <a id="nav-login" href="index.html" class="nav-link">LOGIN</a>
                    <a id="nav-logout" href="#" class="nav-link" style="display:none">LOGOUT</a>
                    <a href="better_reads_PROFILE.html" class="nav-link">PROFILE</a>
                    <a href="better_reads_mb.html" class="nav-link">MY BOOKS</a>
                    <a href="better_reads_browse.html" class="nav-link">BROWSE</a>
                    <div class = "relative " id = "dropdown-parent">
                        <button 
                            class="Drop-Down-Menu-Icon-BTN"
                            aria-expanded="false"
                            aria-haspopup="true"
                            onclick="toggleDropdown(event)"
                            >
                            &#9776;
                        </button>
                        <div
                         id = "dropdown-menu"
                         class = "absolute right-0 mt-3 w-40 bg-white border border-gray-200 rounded-lg shadow-xl hidden origin-top-right transform transition duration-200 ease-out z-30 overflow-hidden">
                        <a href="add-friends.html" class="block px-4 py-2 text-gray-700 hover:bg-orange-100 hover:text-primary-orange transition duration-150 whitespace-nowrap">
                            Add Friends
                        </a>
                        <a href="#" class="block px-4 py-2 text-red-600 hover:bg-red-50 transition duration-150 whitespace-nowrap">
                            Logout
                        </a>
                        </div>
                </nav>
            </div>
        </div>
    </header>
    <main class="relative mb-8">
    <img 
        src="ross-tejada-studying-cat-banner.jpg" 
        alt="Pixel Art Cat Reading" 
        class="w-full max-h-80 h-full object-cover"
    >

    <div class = "container mx-auto px-4 mt-8 py-9 bg-card-background rounded-xl">
        <div class="flex flex-col md:flex-row gap-8">
            <div class="flex-shrink-0 mx-auto md:mx-0">
                <img id="book-cover-img" src="redrising.jpg" alt="Book cover" class="w-56 h-auto object-cover shadow-2xl rounded-lg">
            </div>
            
            <div class="flex-grow">
                <h1 id="book-title" class="text-3xl font-extrabold text-black">Red Rising</h1>
                <p id="book-author" class="text-lg text-gray-700 mb-4">Pierce Brown</p>
                
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <p class="text-sm font-semibold text-dark-brown mb-1">Your Rating:</p>
                        <div class="flex space-x-0.5 text-xl text-yellow-500">
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                        </div>
                    </div>
                    
                    <div class="relative js-add-to-list">
                        <button type="button" id="add-to-list-button"
                                class="bg-primary-orange text-white px-4 py-2 rounded-md shadow-md hover:bg-primary-orange/90 transition-colors flex items-center space-x-2">
                            <span>Add to List</span>
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </button>
                        <div id="add-to-list-menu"
                            class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg border border-gray-200 py-1 text-sm text-gray-800 hidden z-20">
                        </div>
                    </div>

                </div>
                
                <p class="text-gray-800 mb-4 leading-relaxed js-book-description">
                    Darrow is a Red, a member of the lowest caste in the color-coded society of the future. Like his fellow Reds, he works all day, believing that he and his people are making the surface of Mars livable for future generations. Yet he toils willingly, trusting that his blood and sweat will one day result in a better world for his children.
                </p>
                <p class="text-gray-800 leading-relaxed js-book-description">
                    But Darrow and his kind have been betrayed. Soon he discovers that humanity reached the surface generations ago. Vast cities and lush wilds spread across the planet. Darrow—and Reds like him—are nothing more than slaves to a decadent ruling class.
                </p>

                <p class="text-gray-800 leading-relaxed js-book-description">
                    <br>Inspired by a longing for justice, and driven by the memory of lost love, Darrow sacrifices everything to infiltrate the legendary Institute, a proving ground for the dominant Gold caste, where the next generation of humanity’s overlords struggle for power. He will be forced to compete for his life and the very future of civilization against the best and most brutal of Society’s ruling class. There, he will stop at nothing to bring down his enemies . . . even if it means he has to become one of them to do so.
                </p>
                <div id="genre-list" class="flex justify-center flex-wrap gap-x-6 gap-y-2 text-lg font-bold text-dark-brown p-3"></div>
            </div>
        </div> 
    </div> 
    </main>

<footer class="bg-[#51200F] text-white py-4 mt-auto">
    <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center px-4">
        <div class="footer-links space-x-4 mb-2 sm:mb-0">
            <a href="#" class="hover:text-primary transition">About the Company</a>
            <a href="#" class="hover:text-primary transition">Contact Us</a>
        </div>
        <p class="copyright">&copy; Copyright 2025 | Better Reads</p>
    </div>
</footer>
<script>
    (async () => {
        const SUPABASE_URL = "https://swfkspdirzdqotywgvop.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3ZmtzcGRpcnpkcW90eXdndm9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDk4OTEsImV4cCI6MjA3NDgyNTg5MX0.KEH4KkXwYBFA3Frw_Yx8vXPmB2bzJwmdcFhb2Fg6dWY";
        const STORAGE_BASE = "https://swfkspdirzdqotywgvop.supabase.co/storage/v1/object/public/";
        const PLACEHOLDER = STORAGE_BASE + "cover/placeholder.jpg";
        const params = new URLSearchParams(window.location.search);
        const editionId = params.get("edition_id");
        const workIdParam = params.get("work_id");
        let workId = workIdParam || null;
        const API_BASE = "https://beyond-the-bookshelf.onrender.com";
        const token = localStorage.getItem("btb_token");

        async function fetchCurrentUserId() {
            if (!token) return null;
            try {
                const res = await fetch(`${API_BASE}/api/users/me`, {
                    headers: { Authorization: `Bearer ${token}` },
                    mode: "cors",
                });

                if (!res.ok) {
                    console.warn("fetchCurrentUserId: /me", res.status);
                    return null;
                }
                const me = await res.json();
                console.log("Current user from /me:", me);
                return me.user_id || me.id || null;

            } catch (err) {
                console.error("fetchCurrentUserId failed", err);
                return null;
            }
        }
        const CURRENT_USER_ID = await fetchCurrentUserId();
        const loginNavLink = document.querySelector('a.nav-link[href="index.html"]');
        const dropdownLogoutLink = document.querySelector('#dropdown-menu a[href="#"]');

        function handleLogout(event) {
            if (event) event.preventDefault();
            localStorage.removeItem("btb_token");
            window.location.href = "index.html";
        }

        if (CURRENT_USER_ID) {
            if (loginNavLink) {
                loginNavLink.textContent = "LOGOUT";
                loginNavLink.href = "#";
                loginNavLink.addEventListener("click", handleLogout);
            }

            if (dropdownLogoutLink) {
                dropdownLogoutLink.addEventListener("click", handleLogout);
            }

        } else {
            if (loginNavLink) {
                loginNavLink.textContent = "LOGIN";
                loginNavLink.href = "index.html";
            }
        }


        async function addBookToShelf(shelfId) {
            if (!workId) {
                console.error("No work id for shelf item");
                return;
            }
            if (!CURRENT_USER_ID) {
                alert("Please log in first.");
                return;
            }

            const insertUrl = `${SUPABASE_URL}/rest/v1/shelf_items`;
            const payload = {
                shelf_id: shelfId,
                work_id: workId,
            };

            const resp = await fetch(insertUrl, {
                method: "POST",
                headers: {
                    apikey: SUPABASE_ANON_KEY,
                    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                    "Content-Type": "application/json",
                    Prefer: "return=minimal",
                },
                body: JSON.stringify(payload),
            });

            if (!resp.ok && resp.status !== 409) {
                const text = await resp.text();
                console.error("Failed to add to shelf", resp.status, text);
                alert("Sorry, could not add to that list.");
            } else {
                console.log("Added to shelf (or already there)");
            }
        }


        async function addToCurrentReads() {
            if (!CURRENT_USER_ID) {
                alert("Please log in first.");
                return;
            }
            if (!workId) {
                console.error("No work id for current reads");
                return;
            }

            const url = `${SUPABASE_URL}/rest/v1/reading_progress`;
            const payload = {
                user_id: CURRENT_USER_ID,
                work_id: workId,
                progress_percent: 0,
            };

            const resp = await fetch(url, {
                method: "POST",
                headers: {
                    apikey: SUPABASE_ANON_KEY,
                    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                    "Content-Type": "application/json",
                    Prefer: "return=minimal",
                },
                body: JSON.stringify(payload),
            });

            if (!resp.ok && resp.status !== 409) {
                const text = await resp.text();
                console.error("Failed to add to current reads", resp.status, text);
                alert("Sorry, could not add to All current reads.");
            } else {
                console.log("Added to current reads");
            }
        }

        async function addToCompletions() {
            if (!CURRENT_USER_ID) {
                alert("Please log in first.");
                return;
            }
            if (!workId) {
                console.error("No work id for completions");
                return;
            }

            const url = `${SUPABASE_URL}/rest/v1/completions`;
            const payload = {
                user_id: CURRENT_USER_ID,
                work_id: workId,
            };

            const resp = await fetch(url, {
                method: "POST",
                headers: {
                    apikey: SUPABASE_ANON_KEY,
                    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                    "Content-Type": "application/json",
                    Prefer: "return=minimal",
                },
                body: JSON.stringify(payload),
            });

            if (!resp.ok && resp.status !== 409) {
                const text = await resp.text();
                console.error("Failed to add to completions", resp.status, text);
                alert("Sorry, could not add to All completed books.");
            } else {
                console.log("Added to completions");
            }
        }

        if (!editionId && !workIdParam) {
            console.error("No edition_id or work_id in URL");
            return;
        }
        const url = new URL(`${SUPABASE_URL}/rest/v1/editions`);

        if (editionId) {
            url.searchParams.set("edition_id", `eq.${editionId}`);
        } else if (workIdParam) {
            url.searchParams.set("work_id", `eq.${workIdParam}`);
        }
        url.searchParams.set("select", "*,works(*)");
        url.searchParams.set("limit", "1");

        const res = await fetch(url.toString(), {
            headers: {
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
        });

        if (!res.ok) {
            console.error("Failed to load book", res.status);
            return;
        }
        const data = await res.json();
        const book = data[0];

        if (!book) {
            console.error("No book found for that id");
            return;
        }
        const work = book.works || {};
        workId = book.work_id || workIdParam || workId;
        const title = work.title || book.title || "Unknown title";
        const description = work.summary || "Description coming soon";

        let coverSrc = PLACEHOLDER;
        if (book.cover_url) {
            coverSrc = book.cover_url.startsWith("http")
                ? book.cover_url
                : STORAGE_BASE + book.cover_url.replace(/^\/+/, "");
        }
        const coverEl = document.getElementById("book-cover-img");
        const titleEl = document.getElementById("book-title");
        const authorEl = document.getElementById("book-author");
        const descEls = document.querySelectorAll(".js-book-description");

        if (coverEl) {
            coverEl.src = coverSrc;
            coverEl.alt = title;
            coverEl.onerror = () => {
                coverEl.onerror = null;
                coverEl.src = PLACEHOLDER;
            };
        }

        if (titleEl) {
            titleEl.textContent = title;
            document.title = `Better Reads - ${title}`;
        }

        if (descEls.length) {
            descEls[0].textContent = description;
            for (let i = 1; i < descEls.length; i++) {
                descEls[i].style.display = "none";
            }
        }

        if (authorEl && workId) {
            authorEl.textContent = "Author information coming soon";
            const authorsUrl = new URL(`${SUPABASE_URL}/rest/v1/work_authors`);
            authorsUrl.searchParams.set("work_id", `eq.${workId}`);
            authorsUrl.searchParams.set("select", "authors(name)");
            const aRes = await fetch(authorsUrl.toString(), {
                headers: {
                    apikey: SUPABASE_ANON_KEY,
                    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                },
            });

            if (aRes.ok) {
                const aData = await aRes.json();
                console.log("Authors data:", aData);

                const names = aData
                    .map(row => row.authors && row.authors.name)
                    .filter(Boolean);

                if (names.length) {authorEl.textContent = names.join(", ");}
            } else {console.error("Failed to load authors", aRes.status);}
        }

        const addButton = document.getElementById("add-to-list-button");
        const menu = document.getElementById("add-to-list-menu");

        if (addButton && menu) {
            addButton.addEventListener("click", (event) => {
                event.stopPropagation();
                menu.classList.toggle("hidden");
            });

            document.addEventListener("click", () => {
                menu.classList.add("hidden");
            });
            console.log("CURRENT_USER_ID in view-book:", CURRENT_USER_ID);

            if (!CURRENT_USER_ID) {
                menu.innerHTML = "";
                const msg = document.createElement("div");
                msg.className = "px-4 py-2 text-gray-500";
                msg.textContent = "Log in to add this book to a list.";
                menu.appendChild(msg);

            } else {
                const shelvesUrl = new URL(`${SUPABASE_URL}/rest/v1/shelves`);
                shelvesUrl.searchParams.set("user_id", `eq.${CURRENT_USER_ID}`);
                shelvesUrl.searchParams.set("select", "shelf_id,name");
                shelvesUrl.searchParams.set("order", "name.asc");

                const sRes = await fetch(shelvesUrl.toString(), {
                    headers: {
                        apikey: SUPABASE_ANON_KEY,
                        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                });

                if (sRes.ok) {
                    const shelves = await sRes.json();
                    console.log("Shelves data:", shelves);
                    menu.innerHTML = "";

                    function makeMenuButton(label, onClick) {
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "block w-full text-left px-4 py-2 text-sm text-gray-800 hover:bg-background-light";
                        btn.textContent = label;
                        
                        btn.addEventListener("click", async (event) => {
                            event.stopPropagation();

                            try {await onClick();} 
                            finally {menu.classList.add("hidden");}
                        });
                        return btn;
                    }

                    menu.appendChild(
                        makeMenuButton("All current reads", () => addToCurrentReads())
                    );
                    menu.appendChild(
                        makeMenuButton("All completed books", () => addToCompletions())
                    );

                    if (shelves.length) {
                        const divider = document.createElement("div");
                        divider.className = "border-t border-gray-200 my-1";
                        menu.appendChild(divider);

                        for (const shelf of shelves) {
                            menu.appendChild(
                                makeMenuButton(shelf.name, () => addBookToShelf(shelf.shelf_id))
                            );
                        }
                    }

                } else {
                    console.error("Failed to load shelves", sRes.status);
                }
            }
        }

        const genreContainer = document.getElementById("genre-list");
        if (!genreContainer || !workId) return;

        const genresUrl = new URL(`${SUPABASE_URL}/rest/v1/work_genres`);
        genresUrl.searchParams.set("work_id", `eq.${workId}`);
        genresUrl.searchParams.set("select", "genres(name,slug,genre_id)");
        genresUrl.searchParams.set("order", "genres(name)");

        const gRes = await fetch(genresUrl.toString(), {
            headers: {apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`,},
        });

        if (!gRes.ok) {
            console.error("Failed to load genres", gRes.status);
            return;
        }
        const gData = await gRes.json();
        genreContainer.innerHTML = "";

        if (!gData.length) {
            genreContainer.style.display = "none";
            return;
        }

        for (const row of gData) {
            const g = row.genres || {};
            const name = g.name || g.slug || "Unknown";
            const pill = document.createElement("button");
            
            pill.type = "button";
            pill.textContent = name;
            pill.className =
            "px-4 py-1 m-1 rounded-full bg-[#F2DBC8] " +
            "text-[#51200F] text-sm font-semibold " +
            "hover:bg-[#51200F] hover:text-[#F2DBC8] transition-colors";

            genreContainer.appendChild(pill);
        }
    })();
</script>
<script>
    (function () {
        const loginLink = document.getElementById('nav-login');
        const logoutLink = document.getElementById('nav-logout');

        if (!loginLink || !logoutLink) return;
        const token = localStorage.getItem('btb_token');

        if (token) {
            loginLink.style.display = 'none';
            logoutLink.style.display = '';
        } else {
            loginLink.style.display = '';
            logoutLink.style.display = 'none';
        }
        logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();

            try {
                if (window.supabase?.auth?.signOut) {
                    await window.supabase.auth.signOut();
                } else {
                    Object.keys(localStorage)
                        .filter(k => k.includes('supabase') && k.includes('auth'))
                        .forEach(k => localStorage.removeItem(k));
                }
            } catch (_) {}
            localStorage.removeItem('btb_token');
            window.location.href = 'index.html';
        });
    })();
</script>
</body>
</html>