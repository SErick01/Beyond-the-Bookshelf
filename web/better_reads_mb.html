<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse</title>
    <script src = "mb.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/42bbd9a803.js" crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors : {
                        'primary-orange' : '#EB7F50',
                        'background-light': '#F2DBC8',
                        'card-background': '#E5C09E',
                        'dark-brown': '#51200F'
                    },
                    fontFamily: {
                        sans: ['sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<style>
    section{
        padding: 1.25em;
        border-radius: 0.75em;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }
    .nav-link {
        color: #000;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.2s ease;
    }
    
    .nav-link:hover {
        color: #51200F;
    }

    .hidden-modal{
        display:none;
    }
</style>

<body class ="bg-[#F2DBC8] shadow-lg sticky top-0 z-20">
    <header class="bg-[#EB7F50] shadow-lg sticky top-0 z-20">
        <div class="flex  justify-between items-center p-4">
            <div class="flex items-center space-x-3">
                <div class="w-16 h-16">
                    <div class="w-16 h-16">
                    <img 
                        src="Cat_Logo.png" 
                        alt="Cat Logo" 
                        class="w-full h-full object-contain" 
                    >
                    </div>
                </div>
                <h1 class="text-2xl font-extrabold text-black">
                    <a href="better_reads_hp.html" class="nav-link">BETTER READS</a>
                </h1>
            </div>
            
            <div class="flex items-center">
                <nav class="hidden md:flex space-x-6">
                    <a id="nav-login" href="index.html" class="nav-link">LOGIN</a>
                    <a id="nav-logout" href="#" class="nav-link" style="display:none">LOGOUT</a>
                    <a href="better_reads_PROFILE.html" class="nav-link">PROFILE</a>
                    <a href="better_reads_mb.html" class="nav-link">MY BOOKS</a>
                    <a href="better_reads_browse.html" class="nav-link">BROWSE</a>
                    <div class = "relative " id = "dropdown-parent">
                        <button 
                            class="Drop-Down-Menu-Icon-BTN"
                            aria-expanded="false"
                            aria-haspopup="true"
                            onclick="toggleDropdown(event)"
                            >
                            &#9776;
                        </button>
                        <div
                         id = "dropdown-menu"
                         class = "absolute right-0 mt-3 w-40 bg-white border border-gray-200 rounded-lg shadow-xl hidden origin-top-right transform transition duration-200 ease-out z-30 overflow-hidden">
                        <a href="add-friends.html" class="block px-4 py-2 text-gray-700 hover:bg-orange-100 hover:text-primary-orange transition duration-150 whitespace-nowrap">
                            Add Friends
                        </a>
                        <a href="#" class="block px-4 py-2 text-red-600 hover:bg-red-50 transition duration-150 whitespace-nowrap">
                            Logout
                        </a>
                        </div>
                </nav>
            </div>
        </div>
    </header>
    <main class="relative mb-8 shadow-xl">
    <img 
        src="ross-tejada-studying-cat-banner.jpg" 
        alt="Pixel Art Cat Reading" 
        class="w-full max-h-80 h-full object-cover"
    >

    <div class = "container mx-auto px-4 mt-8">

        <form class="w-full max-w-2xl mx-auto mb-10">
        
            <div class="relative flex items-center">
                <i class="fa-solid fa-magnifying-glass pl-4 absolute"></i> 
                <input
                    type="text"
                    placeholder="Search Lists"
                    aria-label="Search field"
                    class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
    
                <button
                    type="button"
                    aria-label="Clear search"
                    class="absolute right-3 text-gray-500 hover:text-gray-700 focus:outline-none"
                    onclick="document.querySelector('input[type=text]').value = '';"
                >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                </button>
            </div>
        </form>
        <div class = "space-y-8 pb-12">
            <div id="shelves-grid" class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <!--Create New List-->
            <section id="new-list-section" class="bg-[#E5C09E]">
                <button id="new-list-btn">
                <h2 class = "text-2xl font-bold text-dark-text mb-6"> + New List</h2>
                <div class = "grid-cols-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-3 bg-E5C09E">
                </div>
                </button>
            </section>
            </div>
        </div>
    </div>
</main>
<div id="list-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300 hidden">
        
    <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-md transform transition-transform duration-300 scale-100">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Create New List</h2>
        <p class="mb-6 text-gray-600">Enter a name for your new reading list:</p>
        
        <input 
            type="text" 
            id="list-name-input" 
            placeholder="e.g., Sci-Fi Favorites, Favorites"
            class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-primary-orange focus:border-primary-orange transition duration-150"
        />
        
        <div class="flex justify-end space-x-3">
            <button 
                id="close-modal-btn"
                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
            >
                Cancel
            </button>
            <button 
                id="create-list-btn"
                class="px-4 py-2 bg-primary-orange text-white rounded-lg font-medium hover:bg-primary-orange/90 transition-colors shadow-md"
            >
                Create
            </button>
        </div>
    </div>
</div>

    <footer class="bg-[#51200F] text-white py-4 mt-auto">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center px-4">
            <div class="footer-links space-x-4 mb-2 sm:mb-0">
                <a href="#" class="hover:text-primary transition">About the Company</a>
                <a href="#" class="hover:text-primary transition">Contact Us</a>
            </div>
            <p class="copyright">&copy; Copyright 2025 | Better Reads</p>
        </div>
    </footer>
<script>
    (async () => {
        const token = localStorage.getItem('btb_token');
        if (!token) {
            window.location.href = 'index.html';
            return;
        }

        try {
            const apiBase = 'https://beyond-the-bookshelf.onrender.com';
            const res = await fetch(`${apiBase}/api/users/me`, {
                headers: { Authorization: `Bearer ${token}` },
                mode: 'cors'
            });
            if (!res.ok) throw new Error('Auth check failed');
        } catch (err) {
            localStorage.removeItem('btb_token');
            window.location.href = 'index.html';
        }
    })();
</script>
<script>
  (function () {
    const loginLink  = document.getElementById('nav-login');
    const logoutLink = document.getElementById('nav-logout');

    if (!loginLink || !logoutLink) return;
    loginLink.style.display = 'none';
    logoutLink.style.display = '';

    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();
      try {
        if (window.supabase?.auth?.signOut) {
          window.supabase.auth.signOut().catch(()=>{});
        }
      } catch (_) {}
      localStorage.removeItem('btb_token');
      window.location.href = 'index.html';
    });
  })();
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const apiBase = 'https://beyond-the-bookshelf.onrender.com';
    const token   = localStorage.getItem('btb_token');
    const fabButton      = document.getElementById('new-list-btn');
    const modal          = document.getElementById('list-modal');
    const closeModalBtn  = document.getElementById('close-modal-btn');
    const createListBtn  = document.getElementById('create-list-btn');
    const listNameInput  = document.getElementById('list-name-input');
    const shelvesGrid    = document.getElementById('shelves-grid');
    const newListSection = document.getElementById('new-list-section');

    if (!shelvesGrid || !newListSection) return;

    const toggleModal = (show) => {
      if (show) {
        modal.classList.remove('hidden');

      } else {
        modal.classList.add('hidden');
        listNameInput.value = '';
      }
    };

    function renderShelfCard(shelf) {
      const section = document.createElement('section');
      section.className = 'bg-[#E5C09E]';
      const shelfId   = shelf.shelf_id ?? shelf.id;
      const name      = shelf.name ?? 'Unnamed list';
      const count     = shelf.book_count ?? 0;
      const countWord = count === 1 ? 'book' : 'books';
      const linkOpen  = shelfId ? `<a href="view-lists.html?shelf_id=${encodeURIComponent(shelfId)}">` : '';
      const linkClose = shelfId ? '</a>' : '';

      section.innerHTML = `
        ${linkOpen}
          <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
            <img
              src="76713323._SY180_.jpg"
              alt="Books"
              class="w-24 h-auto"
            >
            <div class="md:w-2/3 mb-4 md:mb-0 md:pr-6">
              <h2 class="text-2xl font-bold text-dark-text mb-2">${name}</h2>
              <span class="text-sm font-medium text-gray-500 block mb-4">
                <span class="text-gray-700 font-bold">${count}</span> ${countWord} in this list
              </span>
            </div>
          </div>
        ${linkClose}
      `;
      return section;
    }

    async function loadShelves() {
      if (!token) return;

      try {
        const res = await fetch(`${apiBase}/api/home/shelves`, {
          headers: { 'Authorization': `Bearer ${token}` },
          mode: 'cors',
        });

        if (!res.ok) {
          console.error('Failed to load shelves', await res.text());
          return;
        }
        const shelves = await res.json();
        shelves.forEach((shelf) => {
          const card = renderShelfCard(shelf);
          shelvesGrid.insertBefore(card, newListSection);
        });

        if (!shelves.length) {
          const msg = document.createElement('p');
          msg.className = 'text-gray-600 mb-4';
          msg.textContent = 'No lists yet â€” use "New List" to create one.';
          shelvesGrid.insertBefore(msg, newListSection);
        }
      } catch (err) {console.error('Error loading shelves', err);}
    }

    fabButton.addEventListener('click', () => toggleModal(true));
    closeModalBtn.addEventListener('click', () => toggleModal(false));
    modal.addEventListener('click', (event) => {
      if (event.target === modal) toggleModal(false);
    });

    createListBtn.addEventListener('click', async () => {
      const listName = listNameInput.value.trim();
      if (!listName) {
        alert('Please enter a name for your new list.');
        listNameInput.focus();
        return;
      }

      if (!token) {
        window.location.href = 'index.html';
        return;
      }

      try {
        const res = await fetch(`${apiBase}/api/home/shelves`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          mode: 'cors',
          body: JSON.stringify({
            name: listName,
            visibility: 'private',
            is_default: false,
          }),
        });

        if (!res.ok) {
          console.error('Failed to create shelf', await res.text());
          alert('Something went wrong creating the list.');
          return;
        }
        const newShelf = await res.json();
        const card = renderShelfCard(newShelf);
        shelvesGrid.insertBefore(card, newListSection);
        toggleModal(false);

      } catch (err) {
        console.error('Error creating shelf', err);
        alert('Something went wrong creating the list.');
      }
    });
    loadShelves();
  });
</script>
</body>
</html>