<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/42bbd9a803.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<style>
    section{
        padding: 1.25em;
        border-radius: 0.75em;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }
    .nav-link {
        color: #000;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.2s ease;
    }
    
    .nav-link:hover {
        color: #51200F;
    }
</style>

<body class ="bg-[#F2DBC8] shadow-lg sticky top-0 z-20">
    <header class="bg-[#EB7F50] shadow-lg sticky top-0 z-20">
        <div class="flex  justify-between items-center p-4">
            <div class="flex items-center space-x-3">
                <div class="w-16 h-16">
                    <div class="w-16 h-16">
                    <img 
                        src="Cat_Logo.png" 
                        alt="Cat Logo" 
                        class="w-full h-full object-contain" 
                    >
                    </div>
                </div>
                <h1 class="text-2xl font-extrabold text-black">
                    <a href="better_reads_hp.html" class="nav-link">BETTER READS</a>
                </h1>
            </div>
            
            <div class="flex items-center">
                <nav class="hidden md:flex space-x-6">
                    <a id="nav-login" href="index.html" class="nav-link">LOGIN</a>
                    <a id="nav-logout" href="#" class="nav-link" style="display:none">LOGOUT</a>
                    <a href="better_reads_PROFILE.html" class="nav-link">PROFILE</a>
                    <a href="better_reads_mb.html" class="nav-link">MY BOOKS</a>
                    <a href="better_reads_browse.html" class="nav-link">BROWSE</a>
                    <div class = "relative " id = "dropdown-parent">
                        <button 
                            class="Drop-Down-Menu-Icon-BTN"
                            aria-expanded="false"
                            aria-haspopup="true"
                            onclick="toggleDropdown(event)"
                            >
                            &#9776;
                        </button>
                        <div
                         id = "dropdown-menu"
                         class = "absolute right-0 mt-3 w-40 bg-white border border-gray-200 rounded-lg shadow-xl hidden origin-top-right transform transition duration-200 ease-out z-30 overflow-hidden">
                        <a href="add-friends.html" class="block px-4 py-2 text-gray-700 hover:bg-orange-100 hover:text-primary-orange transition duration-150 whitespace-nowrap">
                            Add Friends
                        </a>
                        <a href="#" class="block px-4 py-2 text-red-600 hover:bg-red-50 transition duration-150 whitespace-nowrap">
                            Logout
                        </a>
                        </div>
                </nav>
            </div>
        </div>
    </header>
    <main class="relative mb-8 shadow-xl">
    <img 
        src="ross-tejada-studying-cat-banner.jpg" 
        alt="Pixel Art Cat Reading" 
        class="w-full max-h-80 h-full object-cover"
    >

    <div class = "container mx-auto px-4 mt-8">

        <form id="search-form" class="w-full max-w-2xl mx-auto mb-10">
        
            <div class="relative flex items-center">
                <i class="fa-solid fa-magnifying-glass pl-4 absolute"></i> 
                <input
                    id="search-input"
                    type="text"
                    placeholder="Search Books"
                    aria-label="Search field"
                    class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-3xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
    
                <button
                    type="button"
                    aria-label="Clear search"
                    class="absolute right-3 text-gray-500 hover:text-gray-700 focus:outline-none"
                    onclick="document.querySelector('input[type=text]').value = '';"
                >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                </button>
            </div>
        </form>

        <div class = "space-y-12 pb-12">
            <section class = "bg-[#E5C09E] p-4 rounded-lg">
                <h2 id="recommended-heading" class = "text-2xl font-bold text-dark-text mb-6">Recommended for you</h2>
                <div id="row-recommended" class="Recommended-books grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-3 bg-E5C09E"></div>
            </section>
            <section class = "bg-[#E5C09E]">
                <h2 class = "text-2xl font-bold text-dark-text mb-6">Fantasy</h2>
                <div id="row-fantasy" class="Recommended-books grid grid-cols-2 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-3 bg-E5C09E"></div>
            </section>
            <section class = "bg-[#E5C09E]">
                <h2 class = "text-2xl font-bold text-dark-text mb-6">Sci-Fi</h2>
                <div id="row-scifi" class="Recommended-books grid grid-cols-2 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-3 bg-E5C09E"></div>
            </section>
        </div>
    </div>
</main>
    <footer class="bg-[#51200F] text-white py-4 mt-auto">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center px-4">
            <div class="footer-links space-x-4 mb-2 sm:mb-0">
                <a href="#" class="hover:text-primary transition">About the Company</a>
                <a href="#" class="hover:text-primary transition">Contact Us</a>
            </div>
            <p class="copyright">&copy; Copyright 2025 | Better Reads</p>
        </div>
    </footer>
<script>
(async () => {
  const loginLink  = document.getElementById('nav-login');
  const logoutLink = document.getElementById('nav-logout');
  
  if (!loginLink || !logoutLink) return;
  loginLink.style.display  = '';
  logoutLink.style.display = 'none';
  const token = localStorage.getItem('btb_token');
  
  if (token) {
    try {
      const res = await fetch('https://beyond-the-bookshelf.onrender.com/api/users/me', {
        headers: { Authorization: `Bearer ${token}` },
        mode: 'cors'
      });
      if (res.ok) {
        loginLink.style.display  = 'none';
        logoutLink.style.display = '';
      } else {
        localStorage.removeItem('btb_token');
      }
    } catch (_) {
      localStorage.removeItem('btb_token');
    }
  }
  logoutLink.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      if (window.supabase?.auth?.signOut) {
        window.supabase.auth.signOut().catch(() => {});
      }
    } finally {
      localStorage.removeItem('btb_token');
      window.location.href = 'index.html';
    }
  });
})();
</script>
<script>
(async () => {
  const SUPABASE_URL = "https://swfkspdirzdqotywgvop.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3ZmtzcGRpcnpkcW90eXdndm9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDk4OTEsImV4cCI6MjA3NDgyNTg5MX0.KEH4KkXwYBFA3Frw_Yx8vXPmB2bzJwmdcFhb2Fg6dWY";
  const STORAGE_BASE = "https://swfkspdirzdqotywgvop.supabase.co/storage/v1/object/public/";
  const PLACEHOLDER = STORAGE_BASE + "cover/placeholder.jpg";
  const searchForm = document.getElementById("search-form");
  const searchInput = document.getElementById("search-input");
  const recHeading = document.getElementById("recommended-heading");
  const apiBase = "https://beyond-the-bookshelf.onrender.com";
  const token = localStorage.getItem("btb_token");

  function renderRow(containerId, rows) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const frag = document.createDocumentFragment();

    for (const row of rows) {
      const title =
        (row && row.works && row.works.title) ||
        row?.title ||
        "Unknown title";
      const workId = row.work_id;
      if (!workId) continue;

      let imgSrc = PLACEHOLDER;
      if (row.cover_url) {
        imgSrc = row.cover_url.startsWith("http")
          ? row.cover_url
          : STORAGE_BASE + row.cover_url.replace(/^\/+/, "");
      }
      const a = document.createElement("a");
      const baseHref = `View-book.html?work_id=${encodeURIComponent(workId)}`;

      if (row.edition_id !== undefined && row.edition_id !== null) {
        a.href = `${baseHref}&edition_id=${encodeURIComponent(row.edition_id)}`;
      } else {
        a.href = baseHref;
      }
      a.className = "block";

      const img = document.createElement("img");
      img.src = imgSrc;
      img.alt = title;
      img.className =
        "w-full h-auto object-cover shadow-xl rounded " +
        "hover:scale-[1.03] transition-transform duration-300 cursor-pointer";
      img.onerror = () => {
        img.onerror = null;
        img.src = PLACEHOLDER;
        if (!a.querySelector("p")) {
          const p = document.createElement("p");
          p.textContent = title;
          p.className =
            "mt-1 text-xs font-semibold text-center text-[#51200F]";
          a.appendChild(p);
        }
      };

      if (!row.cover_url || /placeholder\.jpg$/i.test(imgSrc)) {
        const p = document.createElement("p");
        p.textContent = title;
        p.className = "mt-1 text-xs font-semibold text-center text-[#51200F]";
        a.appendChild(p);
      }

      a.appendChild(img);
      const wrap = document.createElement("div");
      wrap.className = "book-card";
      wrap.appendChild(a);
      frag.appendChild(wrap);
    }
    container.innerHTML = "";
    container.appendChild(frag);
  }

  async function fetchBooks({ limit = 30, searchTerm = "" } = {}) {
    const url = new URL(`${SUPABASE_URL}/rest/v1/editions`);
    url.searchParams.set(
      "select",
      "edition_id,work_id,cover_url,works!inner(title)"
    );
    url.searchParams.set("order", "pub_date.desc");
    url.searchParams.set("limit", String(limit));

    if (searchTerm) {
      const clean = searchTerm.replace(/[%*]/g, "").trim();
      const isbnCandidate = clean.replace(/-/g, "");
      const isLikelyIsbn =
        /^[0-9Xx]+$/.test(isbnCandidate) &&
        isbnCandidate.length >= 10 &&
        isbnCandidate.length <= 13;

      if (isLikelyIsbn) {
        url.searchParams.set("isbn13", `eq.${isbnCandidate}`);
      } else {
        url.searchParams.set("works.title", `ilike.${clean}*`);
      }
    }

    const res = await fetch(url.toString(), {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      },
    });

    if (!res.ok) {
      console.error("Failed to load books", res.status);
      return [];
    }
    return await res.json();
  }

  async function fetchRecommendations(limit = 21) {
    const endpoint = token
      ? `/api/recommend/user?limit=${limit}`
      : `/api/recommend/newest?limit=${limit}`;

    const headers = token ? { Authorization: `Bearer ${token}` } : {};
    const res = await fetch(`${apiBase}${endpoint}`, {
      method: "GET",
      headers,
      mode: "cors",
    });

    if (!res.ok) {
      throw new Error(`Recommend API failed: ${res.status}`);
    }
    return res.json();
  }

  const GENRE_NAME_TO_SLUG = {
  "Fantasy": "fantasy",
  "Science Fiction": "science-fiction",
};

  async function fetchGenreBooks(genreName, limit = 21) {
    const slug = 
      GENRE_NAME_TO_SLUG[genreName] ?? 
      genreName.toLowerCase().replace(/\s+/g, "-");

    const genreUrl = `${supabaseUrl}/rest/v1/genres?select=genre_id,slug,name&slug=eq.${encodeURIComponent(slug)}`;
    const genreResp = await fetch(genreUrl, {
      headers: {
        apikey: supabaseAnonKey,
        Authorization: `Bearer ${supabaseAnonKey}`,
      },
    });
    const genreRows = await genreResp.json();

    if (!genreRows.length) {
      console.warn("[fetchGenreBooks] no genre row for", genreName, "slug:", slug);
      return [];
    }

    const genreId = genreRows[0].genre_id;
    const wgUrl = new URL(`${SUPABASE_URL}/rest/v1/work_genres`);

    wgUrl.searchParams.set("select", "work_id");
    wgUrl.searchParams.set("genre_id", `eq.${genreId}`);
    wgUrl.searchParams.set("limit", String(limit * 5));

    const wgRes = await fetch(wgUrl.toString(), { headers });
    if (!wgRes.ok) {
      console.error("[fetchGenreBooks] failed to load work_genres", wgRes.status);
      return [];
    }

    const wgRows = await wgRes.json();
    const workIds = [...new Set(wgRows.map((row) => row.work_id))];
    if (!workIds.length) {
      console.warn("[fetchGenreBooks] no works for genre", genreName);
      return [];
    }

    const edUrl = new URL(`${SUPABASE_URL}/rest/v1/editions`);
    edUrl.searchParams.set(
      "select",
      "edition_id,work_id,cover_url,works!inner(title)"
    );
    edUrl.searchParams.set("order", "pub_date.desc");
    edUrl.searchParams.set("limit", String(limit));
    edUrl.searchParams.set("work_id", `in.(${workIds.join(",")})`);

    const edRes = await fetch(edUrl.toString(), { headers });
    if (!edRes.ok) {
      console.error("[fetchGenreBooks] failed to load editions", edRes.status);
      return [];
    }
    return await edRes.json();
  }

  let initialRecommendedRows = [];
  try {
    const recRows = await fetchRecommendations(21);
    initialRecommendedRows = recRows;

    if (recHeading) {
      recHeading.textContent = token ? "Recommended for you" : "Newest books";
    }
    renderRow("row-recommended", recRows);

  } catch (err) {
    console.error("[Recommended] API error", err);
    const fallbackRows = await fetchBooks({ limit: 21 });
    initialRecommendedRows = fallbackRows;

    if (recHeading) {
      recHeading.textContent = "Newest books";
    }
    renderRow("row-recommended", fallbackRows);
  }

  let fantasyRows = [];
  let scifiRows = [];

  try {
    fantasyRows = await fetchGenreBooks("Fantasy", 21);
  } catch (err) {
    console.error("[Fantasy genre] error", err);
  }

  try {
    scifiRows = await fetchGenreBooks("Science Fiction", 21);
  } catch (err) {
    console.error("[Sci-Fi genre] error", err);
  }

  if (!fantasyRows.length || !scifiRows.length) {
    const fallbackRows = await fetchBooks({ limit: 30 });
    if (!fantasyRows.length) fantasyRows = fallbackRows;
    if (!scifiRows.length) scifiRows = fallbackRows;
  }

  renderRow("row-fantasy", fantasyRows);
  renderRow("row-scifi", scifiRows);

  if (searchForm && searchInput) {
    searchForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const term = searchInput.value.trim();

      if (!term) {
        if (recHeading) {
          recHeading.textContent = token
            ? "Recommended for you"
            : "Newest books";
        }
        renderRow("row-recommended", initialRecommendedRows);
        return;
      }

      const results = await fetchBooks({ limit: 50, searchTerm: term });
      if (recHeading) {
        recHeading.textContent = `Search results for "${term}"`;
      }
      renderRow("row-recommended", results);
    });
  }
})();
</script>
</body>
</html>
