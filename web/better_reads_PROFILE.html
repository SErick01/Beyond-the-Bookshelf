<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Reads-Profile</title>
    <script src = "https://cdn.tailwindcss.com"></script>
    <script src="hp.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors : {
                        'primary-orange' : '#EB7F50',
                        'background-light': '#F2DBC8',
                        'card-background': '#E5C09E',
                        'dark-brown': '#51200F'
                    },
                    fontFamily: {
                        sans: ['sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        section, .calendar-box, .cat-of-the-day-card {
            padding: 1.25rem; /* p-5 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .nav-link {
        color: #000;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.2s ease;
    }
    
    .nav-link:hover {
        color: #51200F;
    }
    .calendar-box {
            background-color: var(--tw-colors-sidebar-bg);
            color: var(--tw-colors-dark-brown);
        }

        .calendar .Weeks {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            list-style: none;
            padding: 0;
            text-align: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid rgba(81, 32, 15, 0.2);
            padding-bottom: 5px;
        }

        .calendar .Days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            list-style: none;
            padding: 0;
            text-align: center;
        }

        .calendar .Days li {
            padding: 0.5rem 0;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            border-radius: 9999px; /* full rounded */
        }

        .calendar .Days li.inactive {
            color: rgba(81, 32, 15, 0.5); /* lighter dark-brown */
            cursor: default;
        }

        .calendar .Days li.active {
            background-color: var(--tw-colors-primary-orange);
            color: #EB7F50;
            font-weight: bold;
        }

        .calendar .icons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .calendar .icons span {
            cursor: pointer;
            color: var(--tw-colors-dark-brown);
            padding: 0.25rem;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }

        .calendar .icons span:hover {
            background-color: rgba(81, 32, 15, 0.1);
        }
    </style>
</head>
<body class = "bg-[#F2DBC8] font-sans text-dark-text min-h-screen flex flex-col">
    
<!-- Nav BARRRRRRRRRRRR-->
<header class="bg-[#EB7F50] shadow-lg sticky top-0 z-20">
        <div class="flex  justify-between items-center p-4">
            <div class="flex items-center space-x-3">
                <div class="w-16 h-16">
                    <div class="w-16 h-16">
                    <img 
                        src="Cat_Logo.png" 
                        alt="Cat Logo" 
                        class="w-full h-full object-contain" 
                    >
                    </div>
                </div>
                <h1 class="text-2xl font-extrabold text-black">
                    <a href="better_reads_hp.html" class="nav-link">BETTER READS</a>
                </h1>
            </div>
            
            <div class="flex items-center">
                <nav class="hidden md:flex space-x-6">
                    <a id="nav-login" href="index.html" class="nav-link">LOGIN</a>
                    <a id="nav-logout" href="#" class="nav-link" style="display:none">LOGOUT</a>
                    <a href="better_reads_PROFILE.html" class="nav-link">PROFILE</a>
                    <a href="better_reads_mb.html" class="nav-link">MY BOOKS</a>
                    <a href="better_reads_browse.html" class="nav-link">BROWSE</a>
                    <div class = "relative " id = "dropdown-parent">
                        <button 
                            class="Drop-Down-Menu-Icon-BTN"
                            aria-expanded="false"
                            aria-haspopup="true"
                            onclick="toggleDropdown(event)"
                            >
                            &#9776;
                        </button>
                        <div
                         id = "dropdown-menu"
                         class = "absolute right-0 mt-3 w-40 bg-white border border-gray-200 rounded-lg shadow-xl hidden origin-top-right transform transition duration-200 ease-out z-30 overflow-hidden">
                        <a href="add-friends.html" class="block px-4 py-2 text-gray-700 hover:bg-orange-100 hover:text-primary-orange transition duration-150 whitespace-nowrap">
                            Add Friends
                        </a>
                        <a href="#" class="block px-4 py-2 text-red-600 hover:bg-red-50 transition duration-150 whitespace-nowrap">
                            Logout
                        </a>
                        </div>
                </nav>
            </div>
        </div>
    </header>
 
<!-- Banner and Website Logo -->
<main class="relative mb-8 shadow-xl">
    <img 
        src="ross-tejada-studying-cat-banner.jpg" 
        alt="Pixel Art Cat Reading" 
        class="w-full max-h-80 h-full object-cover"
    >    
</main>

<div class = "container mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6 pb-12">
  <section class = "lg:col-span-3 space-y-6 bg-[#BAAF6F] rounded-lg">
      <h2 class = text-2xl font-bold text-dark-text mb-4 >Current Reads</h2>

      <!--Book 1-->
      <div class ="Current-Read-item-1 flex space-x-4 items-start bg-sidebar-bg/70 p-3 rounded-lg">
          <img id="current-cover-1" src = "76713323._SY180_.jpg" alt = "Cover" class = "w-16 h-24 object-cover shadow-md rounded">
          <div class = "flex-grow">
              <p id="current-title-1" class = "font-bold text-base leading-tight">Empire of Storms</p>
              <p id="current-author-1" class = "text-sm text-dark-text/80">Sarah J. Maas </p>
              <div class = "w-full h-2 bg-dark-brown/30 rounded-full mt-2 overflow-hidden relative">
                  <div id="progress-bar-1" 
                      class="bg-primary-orange h-full rounded-full transition-all duration-500 ease-out flex items-center justify-center" 
                      style="width: 25%">
                      <span id="progress-text-1" class="text-white font-bold text-xs" 
                          style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);">
                      </span>
                  </div>
              </div>
              <button id ="update-progress-btn-1" onclick="openModal(1)"
                  class="mt-3 bg-[EB7F50] text-white text-sm px-4 py-1 rounded-full shadow hover:bg-dark-brown transition duration-200"> 
                  Update Progress
              </button>
          </div>
      </div> 

      <!--Book 2-->
      <div class ="Current-Read-item-2 flex space-x-4 items-start bg-sidebar-bg/70 p-3 rounded-lg">
          <img id="current-cover-2" src = "222946916._SY180_.jpg" alt = "Cover" class = "w-16 h-24 object-cover shadow-md rounded">
          <div class = "flex-grow">
              <p id="current-title-2" class = "font-bold text-base leading-tight">For Whom the Belle Tolls</p>
              <p id="current-author-2" class = "text-sm text-dark-text/80">Jaysea Lynn</p>
              <div class = "w-full h-2 bg-dark-brown/30 rounded-full mt-2 overflow-hidden relative">
                  <div id="progress-bar-2" 
                      class="bg-primary-orange h-full rounded-full transition-all duration-500 ease-out flex items-center justify-center" 
                      style="width: 25%">
                      <span id="progress-text-2" class="text-white font-bold text-xs" 
                          style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);">
                      </span>
                  </div>
              </div>
              <button id ="update-progress-btn-2" onclick="openModal(2)"
                  class="mt-3 bg-[EB7F50] text-white text-sm px-4 py-1 rounded-full shadow hover:bg-dark-brown transition duration-200"> 
                  Update Progress
              </button>
          </div>
      </div> 
  </section>


<!-- Favorites -->
<div class="lg:col-span-6 space-y-6">
  <section class="bg-[#E5C09E]">
    <h2 id="favorites-heading" class="text-2xl font-bold mb-6">My Favorites</h2>
    <div
      id="row-favorites"
      class="Recommended-books grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-3 bg-E5C09E"
    >
    </div>
  </section>

<!-- Graphs -->
  <section class="bg-[#E5C09E] mt-6 p-6 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-4 text-center">Reading Stats</h2>

    <div class="space-y-6">

      <!-- Bar: pages per month -->
      <div>
        <h3 class="font-semibold text-center mb-2">Pages read per month</h3>
        <img
          id="pages-chart"
          alt="Error loading chart."
          class="mx-auto max-w-full rounded shadow">
      </div>

      <!-- Pie: genres for the year -->
      <div>
        <h3 class="font-semibold text-center mb-2">Genres read this year</h3>
        <img
          id="genres-chart"
          alt="Error loading chart."
          class="mx-auto max-w-full rounded shadow">
      </div>

      <!-- Scatter: completion timeline -->
      <div>
        <h3 class="font-semibold text-center mb-2">Books finished throughout the year</h3>
        <img
          id="timeline-chart"
          alt="Error loading chart."
          class="mx-auto max-w-full rounded shadow">
      </div>

    </div>
  </section>
</div>

    <aside class="lg:col-span-3 space-y-6">
        <div class="calendar-box bg-sidebar-bg">
            <div class="icons flex justify-between items-center mb-2">
                <span class="material-symbols-rounded cursor-pointer" onclick="navigateCalendar(-1)">chevron_left</span>
                <p id="current-date" class="font-bold text-xl">November 2025</p>
                <span class="material-symbols-rounded cursor-pointer" onclick="navigateCalendar(1)">chevron_right</span>
             </div>
            <div class = "calendar">
                <ul class ="Weeks"> 
                    <li>Sun</li>
                    <li>Mon</li>
                    <li>Tue</li>
                    <li>Wed</li>
                    <li>Thu</li>
                    <li>Fri</li>
                    <li>Sat</li>
                </ul>
                <ul class="Days"></ul>
            </div>
        </aside>
    </div>
</div>

<footer class="bg-[#51200F] text-white py-4 mt-auto">

    <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center px-4">
        <div class="footer-links space-x-4 mb-2 sm:mb-0">
            <a href="#" class="hover:text-primary transition">About the Company</a>
            <a href="#" class="hover:text-primary transition">Contact Us</a>
        </div>
        <p class="copyright">&copy; Copyright 2025 | Better Reads</p>
    </div>
</footer>

<div 
    id="progress-modal" 
    class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center transition-opacity duration-300"
    onclick="closeModalOnOutsideClick(event)">
    <div 
        class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm m-4 transform scale-100 transition-transform duration-300" 
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Update Reading Progress</h3>
        <p class="text-sm text-gray-600 mb-2">Enter the page you’re currently on.</p>
        <p id="total-pages-label" class="text-xs text-gray-500 mb-4"></p>

        <label for="page-input" class="block text-sm font-medium text-gray-700 mb-2">Current page number</label>
        <input 
            type="number" id="page-input" name="page-input" min="0" step="1"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-orange focus:border-primary-orange text-lg mb-4"/>

        <div id="error-message" class="text-red-500 text-sm mb-4 hidden"></div>

        <div class="flex justify-end space-x-3">
            <button 
                onclick="closeModal()" 
                class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">
                Cancel
            </button>
            <button 
                onclick="updateProgress()" 
                class="px-4 py-2 text-white bg-primary-orange rounded-lg hover:bg-dark-brown font-semibold transition duration-150">
                Submit Update
            </button>
        </div>
    </div>
</div>

<div id="rating-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
        <h3 class="text-2xl font-bold mb-2">Congratulations!</h3>
        <p class="mb-4">You've finished the book. How would you rate it?</p>
        <div id="star-rating-container" class="text-4xl mb-6">
            <span class="cursor-pointer hover:opacity-75" data-rating="1">★</span>
            <span class="cursor-pointer hover:opacity-75" data-rating="2">★</span>
            <span class="cursor-pointer hover:opacity-75" data-rating="3">★</span>
            <span class="cursor-pointer hover:opacity-75" data-rating="4">★</span>
            <span class="cursor-pointer hover:opacity-75" data-rating="5">★</span>
        </div>
        <p id="selected-rating" class="mb-4 text-gray-600">Click a star to rate</p>
        <div class="flex justify-center space-x-3">
            <button onclick="closeRatingModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Skip</button>
            <button onclick="saveRating()" class="bg-primary-orange text-white px-4 py-2 rounded hover:bg-dark-brown">Submit Rating</button>
        </div>
    </div>
</div>

<script>
    let date = new Date();
    let currYear = date.getFullYear();
    let currMonth = date.getMonth(); 
    const monthNames = ["January", "February", "March", "April", "May", "June", "July",
                    "August", "September", "October", "November", "December"];

    // --- DOM Elements (Accessed via DOMContentLoaded) ---
    const currentDateEl = document.getElementById("current-date");
    const daysContainer = document.querySelector(".Days");

    function renderCalendar() {
    let lastDayOfMonth = new Date(currYear, currMonth + 1, 0).getDate();
    let firstDayOfMonthIndex = new Date(currYear, currMonth, 1).getDay();
    let lastDayOfLastMonth = new Date(currYear, currMonth, 0).getDate();
    let liTag = "";

    for (let i = firstDayOfMonthIndex; i > 0; i--) {
        liTag += `<li class="inactive">${lastDayOfLastMonth - i + 1}</li>`;
    }

    for (let i = 1; i <= lastDayOfMonth; i++) { 
        let isToday = i === new Date().getDate() && currMonth === new Date().getMonth() 
            && currYear === new Date().getFullYear() ? "active" : "";
        liTag += `<li class="${isToday}">${i}</li>`;
    }

    const totalCells = firstDayOfMonthIndex + lastDayOfMonth;
    const remainingCells = 42 - totalCells; 
    const nextMonthStart = totalCells <= 35 ? (35 - totalCells) : (42 - totalCells);
    for (let i = 1; i <= nextMonthStart; i++) {
        liTag += `<li class="inactive">${i}</li>`;
    }

    currentDateEl.textContent = `${monthNames[currMonth]} ${currYear}`;
    daysContainer.innerHTML = liTag;
    }

    function navigateCalendar(nav) {
    currMonth += nav;
    if (currMonth < 0 || currMonth > 11) {
        date = new Date(currYear, currMonth);
        currYear = date.getFullYear();
        currMonth = date.getMonth();
    } 
    renderCalendar();
    }

    window.navigateCalendar = navigateCalendar;
    renderCalendar();    
</script>
<script>
    (async () => {
        const token = localStorage.getItem('btb_token');
        if (!token) {
            window.location.href = 'index.html';
            return;
        }

        try {
            const apiBase = 'https://beyond-the-bookshelf.onrender.com';
            const res = await fetch(`${apiBase}/api/users/me`, {
                headers: { Authorization: `Bearer ${token}` },
                mode: 'cors'
            });
            if (!res.ok) throw new Error('Auth check failed');
        } catch (err) {
            localStorage.removeItem('btb_token');
            window.location.href = 'index.html';
        }
    })();
</script>
<script>
  (function () {
    const loginLink  = document.getElementById('nav-login');
    const logoutLink = document.getElementById('nav-logout');

    if (!loginLink || !logoutLink) return;
    loginLink.style.display = 'none';
    logoutLink.style.display = '';

    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();
      try {
        if (window.supabase?.auth?.signOut) {
          window.supabase.auth.signOut().catch(()=>{});
        }
      } catch (_) {}
      localStorage.removeItem('btb_token');
      window.location.href = 'index.html';
    });
  })();
</script>
<script>
  (async () => {
    const favoritesHeading  = document.getElementById("favorites-heading");
    const favoritesContainer = document.getElementById("row-favorites");
    if (!favoritesContainer) return;

    const STORAGE_BASE = "https://swfkspdirzdqotywgvop.supabase.co/storage/v1/object/public/";
    const PLACEHOLDER  = STORAGE_BASE + "cover/placeholder.jpg";

    favoritesContainer.innerHTML =
      `<p class="col-span-3 text-center text-sm text-[#51200F]">
         Loading favorites…
       </p>`;

    const token = localStorage.getItem("btb_token");
    if (!token) {
      favoritesContainer.innerHTML =
        `<p class="col-span-3 text-center text-sm text-[#51200F]">
           Please log in to see your favorites.
         </p>`;
      return;
    }
    const apiBase = "https://beyond-the-bookshelf.onrender.com";

    function renderFavorites(rows) {
      if (!rows || !rows.length) {
        favoritesContainer.innerHTML =
          `<p class="col-span-3 text-center text-sm text-[#51200F]">
             You don't have any favorites yet.
           </p>`;
        return;
      }
      const frag = document.createDocumentFragment();

      for (const row of rows) {
        const title = row.title || "Unknown title";
        let imgSrc = PLACEHOLDER;

        if (row.cover_url) {
          imgSrc = row.cover_url.startsWith("http")
            ? row.cover_url
            : STORAGE_BASE + row.cover_url.replace(/^\/+/, "");
        }

        const link = document.createElement("a");
        link.href =
          `View-book.html?work_id=${encodeURIComponent(row.work_id)}` +
          `&edition_id=${encodeURIComponent(row.edition_id ?? "")}`;
        link.className = "block";

        const img = document.createElement("img");
        img.src = imgSrc;
        img.alt = title;
        img.className =
          "w-full h-auto object-cover shadow-xl rounded " +
          "hover:scale-[1.03] transition-transform duration-300 cursor-pointer";

        img.onerror = () => {
          img.onerror = null;
          img.src = PLACEHOLDER;
          
          if (!link.querySelector("p")) {
            const p = document.createElement("p");
            p.textContent = title;
            p.className =
              "mt-1 text-xs font-semibold text-center text-[#51200F]";
            link.appendChild(p);
          }
        };
        if (!row.cover_url) {
          const p = document.createElement("p");
          p.textContent = title;
          p.className =
            "mt-1 text-xs font-semibold text-center text-[#51200F]";
          link.appendChild(p);
        }
        link.appendChild(img);
        const wrapper = document.createElement("div");
        wrapper.className = "book-card";
        wrapper.appendChild(link);
        frag.appendChild(wrapper);
      }
      favoritesContainer.innerHTML = "";
      favoritesContainer.appendChild(frag);
    }

    try {
      const res = await fetch(`${apiBase}/api/home/favorites?limit=21`, {
        headers: { Authorization: `Bearer ${token}` },
        mode: "cors",
      });

      if (!res.ok) {
        console.warn("[Favorites] API error", res.status);
        favoritesContainer.innerHTML =
          `<p class="col-span-3 text-center text-sm text-red-700">
             Error loading favorites (${res.status}).
           </p>`;
        return;
      }

      const data = await res.json();
      renderFavorites(data);
    } catch (err) {
      console.error("[Favorites] Fetch failed", err);
      favoritesContainer.innerHTML =
        `<p class="col-span-3 text-center text-sm text-red-700">
           Error loading favorites.
         </p>`;
    }
  })();
</script>
<script>
  (async () => {
    const token = localStorage.getItem("btb_token");
    if (!token) {
      return;
    }

    const apiBase = "https://beyond-the-bookshelf.onrender.com";
    const year = new Date().getFullYear();
    const charts = [
      { elemId: "pages-chart",    path: `/api/home/stats/${year}/pages` },
      { elemId: "genres-chart",   path: `/api/home/stats/${year}/genres` },
      { elemId: "timeline-chart", path: `/api/home/stats/${year}/timeline` },
    ];

    for (const chart of charts) {
      const img = document.getElementById(chart.elemId);
      if (!img) continue;
      img.alt = "Loading chart...";

      try {
        const res = await fetch(`${apiBase}${chart.path}`, {
          headers: { Authorization: `Bearer ${token}` },
          mode: "cors",
        });

        if (!res.ok) {
          console.warn(`[Charts] ${chart.elemId} API error`, res.status);
          img.alt = `Error loading chart (${res.status}).`;
          continue;
        }

        const blob = await res.blob();
        img.src = URL.createObjectURL(blob);
        img.alt = "";

      } catch (err) {
        console.error(`[Charts] Fetch failed for ${chart.elemId}`, err);
        img.alt = "Error loading chart.";
      }
    }
  })();
</script>
</body>
</html>
